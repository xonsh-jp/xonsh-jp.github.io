


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>xonsh.proc &#8212; xonsh 0.8.5 documentation</title>
    <link rel="stylesheet" href="../../_static/numpy_friendly.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../../_static/magic_conch.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
     
        <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="http://xon.sh/_modules/xonsh/proc.html"/>

  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../sidebar.html">xonsh 0.8.5 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for xonsh.proc</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Interface for running Python functions as subprocess-mode commands.</span>

<span class="sd">Code for several helper methods in the `ProcProxy` class have been reproduced</span>
<span class="sd">without modification from `subprocess.py` in the Python 3.4.2 standard library.</span>
<span class="sd">The contents of `subprocess.py` (and, thus, the reproduced methods) are</span>
<span class="sd">Copyright (c) 2003-2005 by Peter Astrand &lt;astrand@lysator.liu.se&gt; and were</span>
<span class="sd">licensed to the Python Software foundation under a Contributor Agreement.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">collections.abc</span> <span class="k">as</span> <span class="nn">cabc</span>

<span class="kn">from</span> <span class="nn">xonsh.platform</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ON_WINDOWS</span><span class="p">,</span>
    <span class="n">ON_POSIX</span><span class="p">,</span>
    <span class="n">ON_MSYS</span><span class="p">,</span>
    <span class="n">ON_CYGWIN</span><span class="p">,</span>
    <span class="n">CAN_RESIZE_WINDOW</span><span class="p">,</span>
    <span class="n">LFLAG</span><span class="p">,</span>
    <span class="n">CC</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">xonsh.tools</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">redirect_stdout</span><span class="p">,</span>
    <span class="n">redirect_stderr</span><span class="p">,</span>
    <span class="n">print_exception</span><span class="p">,</span>
    <span class="n">XonshCalledProcessError</span><span class="p">,</span>
    <span class="n">findfirst</span><span class="p">,</span>
    <span class="n">on_main_thread</span><span class="p">,</span>
    <span class="n">XonshError</span><span class="p">,</span>
    <span class="n">format_std_prepost</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">xonsh.lazyasd</span> <span class="k">import</span> <span class="n">lazyobject</span><span class="p">,</span> <span class="n">LazyObject</span>
<span class="kn">from</span> <span class="nn">xonsh.jobs</span> <span class="k">import</span> <span class="n">wait_for_active_job</span><span class="p">,</span> <span class="n">give_terminal_to</span><span class="p">,</span> <span class="n">_continue</span>
<span class="kn">from</span> <span class="nn">xonsh.lazyimps</span> <span class="k">import</span> <span class="n">fcntl</span><span class="p">,</span> <span class="n">termios</span><span class="p">,</span> <span class="n">_winapi</span><span class="p">,</span> <span class="n">msvcrt</span><span class="p">,</span> <span class="n">winutils</span>

<span class="c1"># these decorators are imported for users back-compatible</span>
<span class="kn">from</span> <span class="nn">xonsh.tools</span> <span class="k">import</span> <span class="n">unthreadable</span><span class="p">,</span> <span class="n">uncapturable</span>  <span class="c1"># NOQA</span>

<span class="c1"># foreground has be deprecated</span>
<span class="n">foreground</span> <span class="o">=</span> <span class="n">unthreadable</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">STDOUT_CAPTURE_KINDS</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">])</span>


<span class="c1"># The following escape codes are xterm codes.</span>
<span class="c1"># See http://rtfm.etla.org/xterm/ctlseq.html for more.</span>
<span class="n">MODE_NUMS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;1049&quot;</span><span class="p">,</span> <span class="s2">&quot;47&quot;</span><span class="p">,</span> <span class="s2">&quot;1047&quot;</span><span class="p">)</span>
<span class="n">START_ALTERNATE_MODE</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[?</span><span class="si">{0}</span><span class="s2">h&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">MODE_NUMS</span><span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;START_ALTERNATE_MODE&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">END_ALTERNATE_MODE</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[?</span><span class="si">{0}</span><span class="s2">l&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">MODE_NUMS</span><span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;END_ALTERNATE_MODE&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ALTERNATE_MODE_FLAGS</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">START_ALTERNATE_MODE</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">END_ALTERNATE_MODE</span><span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;ALTERNATE_MODE_FLAGS&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">RE_HIDDEN_BYTES</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;(</span><span class="se">\001</span><span class="s2">.*?</span><span class="se">\002</span><span class="s2">)&quot;</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;RE_HIDDEN&quot;</span>
<span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">RE_VT100_ESCAPE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;(</span><span class="se">\x9B</span><span class="s2">|</span><span class="se">\x1B\\</span><span class="s2">[)[0-?]*[ -</span><span class="se">\\</span><span class="s2">/]*[@-~]&quot;</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">RE_HIDE_ESCAPE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">b</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">RE_HIDDEN_BYTES</span><span class="o">.</span><span class="n">pattern</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">RE_VT100_ESCAPE</span><span class="o">.</span><span class="n">pattern</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;)&quot;</span>
    <span class="p">)</span>


<div class="viewcode-block" id="QueueReader"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.QueueReader">[docs]</a><span class="k">class</span> <span class="nc">QueueReader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Provides a file-like interface to reading from a queue.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fd : int</span>
<span class="sd">            A file descriptor</span>
<span class="sd">        timeout : float or None, optional</span>
<span class="sd">            The queue reading timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="QueueReader.close"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.QueueReader.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;close the reader&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="QueueReader.is_fully_read"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.QueueReader.is_fully_read">[docs]</a>    <span class="k">def</span> <span class="nf">is_fully_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether or not the queue is fully read and the reader is</span>
<span class="sd">        closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">())</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="QueueReader.read_queue"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.QueueReader.read_queue">[docs]</a>    <span class="k">def</span> <span class="nf">read_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads a single chunk from the queue. This is blocking if</span>
<span class="sd">        the timeout is None and non-blocking otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="QueueReader.read"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.QueueReader.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads bytes from the file.&quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_queue</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">+=</span> <span class="n">line</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">buf</span></div>

<div class="viewcode-block" id="QueueReader.readline"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.QueueReader.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads a line, or a partial line from the file descriptor.&quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_queue</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">+=</span> <span class="n">line</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">nl</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">buf</span></div>

    <span class="k">def</span> <span class="nf">_read_all_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This reads all remaining lines in a blocking fashion.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fully_read</span><span class="p">():</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_queue</span><span class="p">()</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lines</span>

<div class="viewcode-block" id="QueueReader.readlines"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.QueueReader.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hint</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads lines from the file descriptor. This is blocking for negative</span>
<span class="sd">        hints (i.e. read all the remaining lines) and non-blocking otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">hint</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_all_lines</span><span class="p">()</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hint</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_queue</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="QueueReader.fileno"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.QueueReader.fileno">[docs]</a>    <span class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the file descriptor number.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd</span></div>

<div class="viewcode-block" id="QueueReader.readable"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.QueueReader.readable">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">readable</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Returns true, because this object is always readable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="QueueReader.iterqueue"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.QueueReader.iterqueue">[docs]</a>    <span class="k">def</span> <span class="nf">iterqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterates through all remaining chunks in a blocking fashion.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fully_read</span><span class="p">():</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_queue</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">chunk</span></div></div>


<div class="viewcode-block" id="populate_fd_queue"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.populate_fd_queue">[docs]</a><span class="k">def</span> <span class="nf">populate_fd_queue</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads 1 kb of data from a file descriptor into a queue.</span>
<span class="sd">    If this ends or fails, it flags the calling reader object as closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span></div>


<div class="viewcode-block" id="NonBlockingFDReader"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.NonBlockingFDReader">[docs]</a><span class="k">class</span> <span class="nc">NonBlockingFDReader</span><span class="p">(</span><span class="n">QueueReader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class for reading characters from a file descriptor on a background</span>
<span class="sd">    thread. This has the advantages that the calling thread can close the</span>
<span class="sd">    file and that the reading does not block the calling thread.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fd : int</span>
<span class="sd">            A file descriptor</span>
<span class="sd">        timeout : float or None, optional</span>
<span class="sd">            The queue reading timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="c1"># start reading from stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">populate_fd_queue</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="populate_buffer"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.populate_buffer">[docs]</a><span class="k">def</span> <span class="nf">populate_buffer</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads bytes from the file descriptor and copies them into a buffer.</span>

<span class="sd">    The reads happen in parallel using the pread() syscall; which is only</span>
<span class="sd">    available on POSIX systems. If the read fails for any reason, the reader is</span>
<span class="sd">    flagged as closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pread</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">buf</span><span class="p">:</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span></div>


<div class="viewcode-block" id="BufferedFDParallelReader"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.BufferedFDParallelReader">[docs]</a><span class="k">class</span> <span class="nc">BufferedFDParallelReader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Buffered, parallel background thread reader.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fd : int</span>
<span class="sd">            File descriptor from which to read.</span>
<span class="sd">        buffer : binary file-like or None, optional</span>
<span class="sd">            A buffer to write bytes into. If None, a new BytesIO object</span>
<span class="sd">            is created.</span>
<span class="sd">        chunksize : int, optional</span>
<span class="sd">            The max size of the parallel reads, default 1 kb.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span> <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunksize</span> <span class="o">=</span> <span class="n">chunksize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># start reading from stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">populate_buffer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">_expand_console_buffer</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">max_offset</span><span class="p">,</span> <span class="n">expandsize</span><span class="p">,</span> <span class="n">orig_posize</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
    <span class="c1"># if we are getting close to the end of the console buffer,</span>
    <span class="c1"># expand it so that we can read from it successfully.</span>
    <span class="k">if</span> <span class="n">cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">orig_posize</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">max_offset</span><span class="p">,</span> <span class="n">orig_posize</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">((</span><span class="n">max_offset</span> <span class="o">+</span> <span class="n">expandsize</span><span class="p">)</span> <span class="o">//</span> <span class="n">cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">winutils</span><span class="o">.</span><span class="n">set_console_screen_buffer_size</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span>
    <span class="n">orig_posize</span> <span class="o">=</span> <span class="n">orig_posize</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rows</span><span class="p">,)</span>
    <span class="n">max_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cols</span>
    <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">max_offset</span><span class="p">,</span> <span class="n">orig_posize</span>


<div class="viewcode-block" id="populate_console"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.populate_console">[docs]</a><span class="k">def</span> <span class="nf">populate_console</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">expandsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads bytes from the file descriptor and puts lines into the queue.</span>
<span class="sd">    The reads happened in parallel,</span>
<span class="sd">    using xonsh.winutils.read_console_output_character(),</span>
<span class="sd">    and is thus only available on windows. If the read fails for any reason,</span>
<span class="sd">    the reader is flagged as closed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># OK, so this function is super annoying because Windows stores its</span>
    <span class="c1"># buffers as a 2D regular, dense array -- without trailing newlines.</span>
    <span class="c1"># Meanwhile, we want to add *lines* to the queue. Also, as is typical</span>
    <span class="c1"># with parallel reads, the entire buffer that you ask for may not be</span>
    <span class="c1"># filled. Thus we have to deal with the full generality.</span>
    <span class="c1">#   1. reads may end in the middle of a line</span>
    <span class="c1">#   2. excess whitespace at the end of a line may not be real, unless</span>
    <span class="c1">#   3. you haven&#39;t read to the end of the line yet!</span>
    <span class="c1"># So there are alignment issues everywhere.  Also, Windows will automatically</span>
    <span class="c1"># read past the current cursor position, even though there is presumably</span>
    <span class="c1"># nothing to see there.</span>
    <span class="c1">#</span>
    <span class="c1"># These chunked reads basically need to happen like this because,</span>
    <span class="c1">#   a. The default buffer size is HUGE for the console (90k lines x 120 cols)</span>
    <span class="c1">#      as so we can&#39;t just read in everything at the end and see what we</span>
    <span class="c1">#      care about without a noticeable performance hit.</span>
    <span class="c1">#   b. Even with this huge size, it is still possible to write more lines than</span>
    <span class="c1">#      this, so we should scroll along with the console.</span>
    <span class="c1"># Unfortunately, because we do not have control over the terminal emulator,</span>
    <span class="c1"># It is not possible to compute how far back we should set the beginning</span>
    <span class="c1"># read position because we don&#39;t know how many characters have been popped</span>
    <span class="c1"># off the top of the buffer. If we did somehow know this number we could do</span>
    <span class="c1"># something like the following:</span>
    <span class="c1">#</span>
    <span class="c1">#    new_offset = (y*cols) + x</span>
    <span class="c1">#    if new_offset == max_offset:</span>
    <span class="c1">#        new_offset -= scrolled_offset</span>
    <span class="c1">#        x = new_offset%cols</span>
    <span class="c1">#        y = new_offset//cols</span>
    <span class="c1">#        continue</span>
    <span class="c1">#</span>
    <span class="c1"># So this method is imperfect and only works as long as the screen has</span>
    <span class="c1"># room to expand to.  Thus the trick here is to expand the screen size</span>
    <span class="c1"># when we get close enough to the end of the screen. There remain some</span>
    <span class="c1"># async issues related to not being able to set the cursor position.</span>
    <span class="c1"># but they just affect the alignment / capture of the output of the</span>
    <span class="c1"># first command run after a screen resize.</span>
    <span class="k">if</span> <span class="n">expandsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">expandsize</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">chunksize</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">posize</span> <span class="o">=</span> <span class="n">winutils</span><span class="o">.</span><span class="n">get_position_size</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
    <span class="n">pre_x</span> <span class="o">=</span> <span class="n">pre_y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">orig_posize</span> <span class="o">=</span> <span class="n">posize</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">cols</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span>
    <span class="n">max_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cols</span>
    <span class="c1"># I believe that there is a bug in PTK that if we reset the</span>
    <span class="c1"># cursor position, the cursor on the next prompt is accidentally on</span>
    <span class="c1"># the next line.  If this is fixed, uncomment the following line.</span>
    <span class="c1"># if max_offset &lt; offset + expandsize:</span>
    <span class="c1">#     rows, max_offset, orig_posize = _expand_console_buffer(</span>
    <span class="c1">#                                        cols, max_offset, expandsize,</span>
    <span class="c1">#                                        orig_posize, fd)</span>
    <span class="c1">#     winutils.set_console_cursor_position(x, y, fd=fd)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">posize</span> <span class="o">=</span> <span class="n">winutils</span><span class="o">.</span><span class="n">get_position_size</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">cols</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">posize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">posize</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="n">posize</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">pre_x</span> <span class="o">==</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">pre_y</span> <span class="o">==</span> <span class="n">y</span>
        <span class="p">):</span>
            <span class="c1"># already at or ahead of the current cursor position.</span>
            <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">max_offset</span> <span class="o">&lt;=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">expandsize</span><span class="p">:</span>
            <span class="n">ecb</span> <span class="o">=</span> <span class="n">_expand_console_buffer</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">max_offset</span><span class="p">,</span> <span class="n">expandsize</span><span class="p">,</span> <span class="n">orig_posize</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
            <span class="n">rows</span><span class="p">,</span> <span class="n">max_offset</span><span class="p">,</span> <span class="n">orig_posize</span> <span class="o">=</span> <span class="n">ecb</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">posize</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
            <span class="c1"># cursor updated but screen size is the same.</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># screen size changed, which is offset preserving</span>
            <span class="n">orig_posize</span> <span class="o">=</span> <span class="n">posize</span>
            <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">posize</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">%</span> <span class="n">cols</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">//</span> <span class="n">cols</span>
            <span class="n">pre_x</span> <span class="o">=</span> <span class="n">pre_y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">max_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cols</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">winutils</span><span class="o">.</span><span class="n">read_console_output_character</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
        <span class="c1"># cursor position and offset</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reader</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="n">nread</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nread</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">cur_x</span><span class="p">,</span> <span class="n">cur_y</span> <span class="o">=</span> <span class="n">posize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cur_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">cols</span> <span class="o">*</span> <span class="n">cur_y</span><span class="p">)</span> <span class="o">+</span> <span class="n">cur_x</span>
        <span class="n">beg_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">cols</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span>
        <span class="n">end_offset</span> <span class="o">=</span> <span class="n">beg_offset</span> <span class="o">+</span> <span class="n">nread</span>
        <span class="k">if</span> <span class="n">end_offset</span> <span class="o">&gt;</span> <span class="n">cur_offset</span> <span class="ow">and</span> <span class="n">cur_offset</span> <span class="o">!=</span> <span class="n">max_offset</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span> <span class="n">cur_offset</span> <span class="o">-</span> <span class="n">end_offset</span><span class="p">]</span>
        <span class="c1"># convert to lines</span>
        <span class="n">xshift</span> <span class="o">=</span> <span class="n">cols</span> <span class="o">-</span> <span class="n">x</span>
        <span class="n">yshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">nread</span> <span class="o">//</span> <span class="n">cols</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">nread</span> <span class="o">%</span> <span class="n">cols</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">buf</span><span class="p">[:</span><span class="n">xshift</span><span class="p">]]</span>
        <span class="n">lines</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">buf</span><span class="p">[</span><span class="n">l</span> <span class="o">*</span> <span class="n">cols</span> <span class="o">+</span> <span class="n">xshift</span> <span class="p">:</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cols</span> <span class="o">+</span> <span class="n">xshift</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">yshift</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># put lines in the queue</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="n">nl</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">xshift</span><span class="p">:</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="n">nl</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># update x and y locations</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">beg_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">%</span> <span class="n">cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_offset</span> <span class="o">=</span> <span class="n">beg_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_offset</span> <span class="o">=</span> <span class="n">beg_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
        <span class="n">pre_x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">pre_y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">new_offset</span> <span class="o">%</span> <span class="n">cols</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">new_offset</span> <span class="o">//</span> <span class="n">cols</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConsoleParallelReader"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.ConsoleParallelReader">[docs]</a><span class="k">class</span> <span class="nc">ConsoleParallelReader</span><span class="p">(</span><span class="n">QueueReader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parallel reader for consoles that runs in a background thread.</span>
<span class="sd">    This is only needed, available, and useful on Windows.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fd : int</span>
<span class="sd">            Standard buffer file descriptor, 0 for stdin, 1 for stdout (default),</span>
<span class="sd">            and 2 for stderr.</span>
<span class="sd">        buffer : ctypes.c_wchar_p, optional</span>
<span class="sd">            An existing buffer to (re-)use.</span>
<span class="sd">        chunksize : int, optional</span>
<span class="sd">            The max size of the parallel reads, default 1 kb.</span>
<span class="sd">        timeout : float, optional</span>
<span class="sd">            The queue reading timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_PROC_FREQUENCY&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">buffer</span>  <span class="c1"># this cannot be public</span>
        <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">chunksize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunksize</span> <span class="o">=</span> <span class="n">chunksize</span>
        <span class="c1"># start reading from stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">populate_console</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="safe_fdclose"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.safe_fdclose">[docs]</a><span class="k">def</span> <span class="nf">safe_fdclose</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closes a file handle in the safest way possible, and potentially</span>
<span class="sd">    storing the result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># don&#39;t close stdin, stdout, stderr, -1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">handle</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">or</span> <span class="n">handle</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">or</span> <span class="n">handle</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
        <span class="c1"># don&#39;t close stdin, stdout, or stderr</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span></div>


<div class="viewcode-block" id="safe_flush"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.safe_flush">[docs]</a><span class="k">def</span> <span class="nf">safe_flush</span><span class="p">(</span><span class="n">handle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attempts to safely flush a file handle, returns success bool.&quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">status</span></div>


<div class="viewcode-block" id="still_writable"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.still_writable">[docs]</a><span class="k">def</span> <span class="nf">still_writable</span><span class="p">(</span><span class="n">fd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines whether a file descriptor is still writable by trying to</span>
<span class="sd">    write an empty string and seeing if it fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">status</span></div>


<div class="viewcode-block" id="PopenThread"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.PopenThread">[docs]</a><span class="k">class</span> <span class="nc">PopenThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A thread for running and managing subprocess. This allows reading</span>
<span class="sd">    from the stdin, stdout, and stderr streams in a non-blocking fashion.</span>

<span class="sd">    This takes the same arguments and keyword arguments as regular Popen.</span>
<span class="sd">    This requires that the captured_stdout and captured_stderr attributes</span>
<span class="sd">    to be set following instantiation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span>
        <span class="c1"># stdin setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_stdin</span> <span class="o">=</span> <span class="n">stdin</span>
        <span class="k">if</span> <span class="n">stdin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdin_fd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdin_fd</span> <span class="o">=</span> <span class="n">stdin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdin_fd</span> <span class="o">=</span> <span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_stdin</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_STORE_STDIN&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_PROC_FREQUENCY&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_alt_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdin_mode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># stdout setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_fd</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_pty_size</span><span class="p">()</span>
        <span class="c1"># stderr setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_stderr</span> <span class="o">=</span> <span class="n">stderr</span>
        <span class="c1"># Set some signal handles, if we can. Must come before process</span>
        <span class="c1"># is started to prevent deadlock on windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># has to be here for closure for handles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_int_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_winch_handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_tstp_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_quit_handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">on_main_thread</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_int_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_int</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ON_POSIX</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">old_tstp_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTSTP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_tstp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">old_quit_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGQUIT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_quit</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">CAN_RESIZE_WINDOW</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">old_winch_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_winch</span>
                <span class="p">)</span>
        <span class="c1"># start up process</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="ow">and</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">set_inheritable</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clean_up</span><span class="p">()</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universal_newlines</span> <span class="o">=</span> <span class="n">uninew</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">universal_newlines</span>
        <span class="k">if</span> <span class="n">uninew</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">enc</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encoding_errors</span> <span class="o">=</span> <span class="n">err</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>  <span class="c1"># stdin is always bytes!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(),</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(),</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding_errors</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevs_are_closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<div class="viewcode-block" id="PopenThread.run"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.PopenThread.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the subprocess by performing a parallel read on stdin if allowed,</span>
<span class="sd">        and copying bytes from captured_stdout to stdout and bytes from</span>
<span class="sd">        captured_stderr to stderr.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_and_getattr</span><span class="p">(</span><span class="s2">&quot;spec&quot;</span><span class="p">)</span>
        <span class="c1"># get stdin and apply parallel reader if needed.</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_stdin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">ON_POSIX</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_stdin</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_stdin</span>
            <span class="n">origfd</span> <span class="o">=</span> <span class="n">origin</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">origin</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">BufferedFDParallelReader</span><span class="p">(</span><span class="n">origfd</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">stdin</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># get non-blocking stdout</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">universal_newlines</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">capout</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">captured_stdout</span>
        <span class="k">if</span> <span class="n">capout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">procout</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">procout</span> <span class="o">=</span> <span class="n">NonBlockingFDReader</span><span class="p">(</span><span class="n">capout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="c1"># get non-blocking stderr</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">buffer</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">universal_newlines</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">caperr</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">captured_stderr</span>
        <span class="k">if</span> <span class="n">caperr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">procerr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">procerr</span> <span class="o">=</span> <span class="n">NonBlockingFDReader</span><span class="p">(</span><span class="n">caperr</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="c1"># initial read from buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_write</span><span class="p">(</span><span class="n">procout</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_write</span><span class="p">(</span><span class="n">procerr</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">)</span>
        <span class="c1"># loop over reads while process is running.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this is here for CPU performance reasons.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">tout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">*</span> <span class="n">cnt</span>
                <span class="k">if</span> <span class="n">procout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">procout</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">tout</span>
                <span class="k">if</span> <span class="n">procerr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">procerr</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">tout</span>
            <span class="k">elif</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">procout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">procout</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
                <span class="k">if</span> <span class="n">procerr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">procerr</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="c1"># redirect some output!</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_write</span><span class="p">(</span><span class="n">procout</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_write</span><span class="p">(</span><span class="n">procerr</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspended</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspended</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># close files to send EOF to non-blocking reader.</span>
        <span class="c1"># capout &amp; caperr seem to be needed only by Windows, while</span>
        <span class="c1"># orig_stdout &amp; orig_stderr are need by posix and Windows.</span>
        <span class="c1"># Also, order seems to matter here,</span>
        <span class="c1"># with orig_* needed to be closed before cap*</span>
        <span class="n">safe_fdclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_stdout</span><span class="p">)</span>
        <span class="n">safe_fdclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
            <span class="n">safe_fdclose</span><span class="p">(</span><span class="n">capout</span><span class="p">)</span>
            <span class="n">safe_fdclose</span><span class="p">(</span><span class="n">caperr</span><span class="p">)</span>
        <span class="c1"># read in the remaining data in a blocking fashion.</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">procout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">procout</span><span class="o">.</span><span class="n">is_fully_read</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">procerr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">procerr</span><span class="o">.</span><span class="n">is_fully_read</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_write</span><span class="p">(</span><span class="n">procout</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_write</span><span class="p">(</span><span class="n">procerr</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">)</span>
        <span class="c1"># kill the process if it is still alive. Happens when piping.</span>
        <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_wait_and_getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;make sure the instance has a certain attr, and return it.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1e-7</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">stdbuf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads a chunk of bytes from a buffer and write into memory or back</span>
<span class="sd">        down to the standard buffer, as appropriate. Returns the number of</span>
<span class="sd">        successful reads.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">read_queue</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alt_mode_switch</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">stdbuf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">stdbuf</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_alt_mode_switch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">membuf</span><span class="p">,</span> <span class="n">stdbuf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enables recursively switching between normal capturing mode</span>
<span class="sd">        and &#39;alt&#39; mode, which passes through values to the standard</span>
<span class="sd">        buffer. Pagers, text editors, curses applications, etc. use</span>
<span class="sd">        alternate mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">findfirst</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">ALTERNATE_MODE_FLAGS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alt_mode_writer</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">membuf</span><span class="p">,</span> <span class="n">stdbuf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This code is executed when the child process switches the</span>
            <span class="c1"># terminal into or out of alternate mode. The line below assumes</span>
            <span class="c1"># that the user has opened vim, less, or similar, and writes writes</span>
            <span class="c1"># to stdin.</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="c1"># write the first part of the chunk in the current mode.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alt_mode_writer</span><span class="p">(</span><span class="n">chunk</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">membuf</span><span class="p">,</span> <span class="n">stdbuf</span><span class="p">)</span>
            <span class="c1"># switch modes</span>
            <span class="c1"># write the flag itself the current mode where alt mode is on</span>
            <span class="c1"># so that it is streamed to the terminal ASAP.</span>
            <span class="c1"># this is needed for terminal emulators to find the correct</span>
            <span class="c1"># positions before and after alt mode.</span>
            <span class="n">alt_mode</span> <span class="o">=</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">START_ALTERNATE_MODE</span>
            <span class="k">if</span> <span class="n">alt_mode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_alt_mode</span> <span class="o">=</span> <span class="n">alt_mode</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_alt_mode_writer</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">membuf</span><span class="p">,</span> <span class="n">stdbuf</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_enable_cbreak_stdin</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_alt_mode_writer</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">membuf</span><span class="p">,</span> <span class="n">stdbuf</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_alt_mode</span> <span class="o">=</span> <span class="n">alt_mode</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_disable_cbreak_stdin</span><span class="p">()</span>
            <span class="c1"># recurse this function, but without the current flag.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alt_mode_switch</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="n">j</span><span class="p">:],</span> <span class="n">membuf</span><span class="p">,</span> <span class="n">stdbuf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_alt_mode_writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">membuf</span><span class="p">,</span> <span class="n">stdbuf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write bytes to the standard buffer if in alt mode or otherwise</span>
<span class="sd">        to the in-memory buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># don&#39;t write empty values</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_alt_mode</span><span class="p">:</span>
            <span class="n">stdbuf</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">membuf</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="n">membuf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
                <span class="n">membuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">membuf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Window resize handlers</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_signal_winch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Signal handler for SIGWINCH - window size has changed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGWINCH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_pty_size</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_pty_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the window size of the child pty based on the window size of</span>
<span class="sd">        our own controlling terminal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">isatty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout_fd</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c1"># Get the terminal size of the real terminal, set it on the</span>
        <span class="c1">#       pseudoterminal.</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="c1"># 1 = stdout here</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout_fd</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TIOCSWINSZ</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1">#</span>
    <span class="c1"># SIGINT handler</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_signal_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Signal handler for SIGINT - Ctrl+C may have been pressed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signum</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_sigint</span><span class="p">(</span><span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">on_main_thread</span><span class="p">():</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">pthread_kill</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(),</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_restore_sigint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_int_handler</span>
        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">on_main_thread</span><span class="p">():</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_int_handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disable_cbreak_stdin</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_int</span><span class="p">:</span>
                <span class="n">old</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># SIGTSTP handler</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_signal_tstp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Signal handler for suspending SIGTSTP - Ctrl+Z may have been pressed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_sigtstp</span><span class="p">(</span><span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_restore_sigtstp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_tstp_handler</span>
        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">on_main_thread</span><span class="p">():</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTSTP</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_tstp_handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disable_cbreak_stdin</span><span class="p">()</span>

    <span class="c1">#</span>
    <span class="c1"># SIGQUIT handler</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_signal_quit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Signal handler for quiting SIGQUIT - Ctrl+\ may have been pressed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_sigquit</span><span class="p">(</span><span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_restore_sigquit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_quit_handler</span>
        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">on_main_thread</span><span class="p">():</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGQUIT</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_quit_handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disable_cbreak_stdin</span><span class="p">()</span>

    <span class="c1">#</span>
    <span class="c1"># cbreak mode handlers</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_enable_cbreak_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ON_POSIX</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdin_mode</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin_fd</span><span class="p">)[:]</span>
        <span class="k">except</span> <span class="n">termios</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="c1"># this can happen for cases where another process is controlling</span>
            <span class="c1"># xonsh&#39;s tty device, such as in testing.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdin_mode</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin_mode</span><span class="p">[:]</span>
        <span class="n">new</span><span class="p">[</span><span class="n">LFLAG</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">termios</span><span class="o">.</span><span class="n">ECHO</span> <span class="o">|</span> <span class="n">termios</span><span class="o">.</span><span class="n">ICANON</span><span class="p">)</span>
        <span class="n">new</span><span class="p">[</span><span class="n">CC</span><span class="p">][</span><span class="n">termios</span><span class="o">.</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new</span><span class="p">[</span><span class="n">CC</span><span class="p">][</span><span class="n">termios</span><span class="o">.</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># termios.TCSAFLUSH may be less reliable than termios.TCSANOW</span>
            <span class="n">termios</span><span class="o">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin_fd</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TCSANOW</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">termios</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disable_cbreak_stdin</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_disable_cbreak_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ON_POSIX</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin_mode</span><span class="p">[:]</span>
        <span class="n">new</span><span class="p">[</span><span class="n">LFLAG</span><span class="p">]</span> <span class="o">|=</span> <span class="n">termios</span><span class="o">.</span><span class="n">ECHO</span> <span class="o">|</span> <span class="n">termios</span><span class="o">.</span><span class="n">ICANON</span>
        <span class="n">new</span><span class="p">[</span><span class="n">CC</span><span class="p">][</span><span class="n">termios</span><span class="o">.</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new</span><span class="p">[</span><span class="n">CC</span><span class="p">][</span><span class="n">termios</span><span class="o">.</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">termios</span><span class="o">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin_fd</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TCSANOW</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">termios</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1">#</span>
    <span class="c1"># Dispatch methods</span>
    <span class="c1">#</span>

<div class="viewcode-block" id="PopenThread.poll"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.PopenThread.poll">[docs]</a>    <span class="k">def</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatches to Popen.returncode.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span></div>

<div class="viewcode-block" id="PopenThread.wait"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.PopenThread.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatches to Popen.wait(), but also does process cleanup such as</span>
<span class="sd">        joining this thread and replacing the original window size signal</span>
<span class="sd">        handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disable_cbreak_stdin</span><span class="p">()</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="c1"># need to replace the old signal handlers somewhere...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_winch_handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">on_main_thread</span><span class="p">():</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_winch_handler</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_winch_handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_up</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rtn</span></div>

    <span class="k">def</span> <span class="nf">_clean_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_sigint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_sigtstp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_sigquit</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">returncode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process return code.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span>

    <span class="nd">@returncode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">returncode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process return code.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process signal, or None.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="p">,</span> <span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span>
            <span class="k">if</span> <span class="n">rtn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rtn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">rtn</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">WCOREDUMP</span><span class="p">(</span><span class="n">rtn</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="nd">@signal</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process signal, or None.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="PopenThread.send_signal"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.PopenThread.send_signal">[docs]</a>    <span class="k">def</span> <span class="nf">send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatches to Popen.send_signal().&quot;&quot;&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1e-7</span><span class="p">)</span>
            <span class="n">dt</span> <span class="o">+=</span> <span class="mf">1e-7</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
            <span class="c1"># This can happen in the case of !(cmd) when the command has ended</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">rtn</span></div>

<div class="viewcode-block" id="PopenThread.terminate"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.PopenThread.terminate">[docs]</a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatches to Popen.terminate().&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span></div>

<div class="viewcode-block" id="PopenThread.kill"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.PopenThread.kill">[docs]</a>    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatches to Popen.kill().&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="Handle"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.Handle">[docs]</a><span class="k">class</span> <span class="nc">Handle</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
    <span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Handle.Close"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.Handle.Close">[docs]</a>    <span class="k">def</span> <span class="nf">Close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CloseHandle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">CloseHandle</span> <span class="o">=</span> <span class="n">CloseHandle</span> <span class="ow">or</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">CloseHandle</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">CloseHandle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Handle.Detach"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.Handle.Detach">[docs]</a>    <span class="k">def</span> <span class="nf">Detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;already closed&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Handle(</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="fm">__del__</span> <span class="o">=</span> <span class="n">Close</span>
    <span class="fm">__str__</span> <span class="o">=</span> <span class="fm">__repr__</span></div>


<div class="viewcode-block" id="FileThreadDispatcher"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher">[docs]</a><span class="k">class</span> <span class="nc">FileThreadDispatcher</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Dispatches to different file handles depending on the</span>
<span class="sd">    current thread. Useful if you want file operation to go to different</span>
<span class="sd">    places for different threads.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        default : file-like or None, optional</span>
<span class="sd">            The file handle to write to if a thread cannot be found in</span>
<span class="sd">            the registry. If None, a new in-memory instance.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        registry : dict</span>
<span class="sd">            Maps thread idents to file handles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="FileThreadDispatcher.register"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Registers a file handle for the current thread. Returns self so</span>
<span class="sd">        that this method can be used in a with-statement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># prevent weird recurssion errors</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()]</span> <span class="o">=</span> <span class="n">handle</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.deregister"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.deregister">[docs]</a>    <span class="k">def</span> <span class="nf">deregister</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes the current thread from the registry.&quot;&quot;&quot;</span>
        <span class="n">ident</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ident</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
            <span class="c1"># don&#39;t remove if we have already been deregistered</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">available</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the thread is available in the registry.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the current handle for the thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_type</span><span class="p">,</span> <span class="n">ex_value</span><span class="p">,</span> <span class="n">ex_traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deregister</span><span class="p">()</span>

    <span class="c1">#</span>
    <span class="c1"># io.TextIOBase interface</span>
    <span class="c1">#</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the encoding for this thread&#39;s handle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">encoding</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the errors for this thread&#39;s handle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">errors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">newlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the newlines for this thread&#39;s handle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">newlines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the buffer for this thread&#39;s handle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">buffer</span>

<div class="viewcode-block" id="FileThreadDispatcher.detach"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.detach">[docs]</a>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detaches the buffer for the current thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.read"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads from the handle for the current thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.readline"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads a line from the handle for the current thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.readlines"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hint</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads lines from the handle for the current thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.seek"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.seek">[docs]</a>    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seeks the current file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.tell"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.tell">[docs]</a>    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reports the current position in the handle for the current thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.write"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes to this thread&#39;s handle. This also flushes, just to be</span>
<span class="sd">        extra sure the string was written.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">r</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">line_buffering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets if line buffering for this thread&#39;s handle enabled.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">line_buffering</span>

    <span class="c1">#</span>
    <span class="c1"># io.IOBase interface</span>
    <span class="c1">#</span>

<div class="viewcode-block" id="FileThreadDispatcher.close"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes the current thread&#39;s handle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is the thread&#39;s handle closed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">closed</span>

<div class="viewcode-block" id="FileThreadDispatcher.fileno"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.fileno">[docs]</a>    <span class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the file descriptor for the current thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.flush"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flushes the file descriptor for the current thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">safe_flush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">)</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.isatty"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.isatty">[docs]</a>    <span class="k">def</span> <span class="nf">isatty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns if the file descriptor for the current thread is a tty.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.readable"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.readable">[docs]</a>    <span class="k">def</span> <span class="nf">readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns if file descriptor for the current thread is readable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">readable</span><span class="p">()</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.seekable"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.seekable">[docs]</a>    <span class="k">def</span> <span class="nf">seekable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns if file descriptor for the current thread is seekable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">seekable</span><span class="p">()</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.truncate"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.truncate">[docs]</a>    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Truncates the file for for the current thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.writable"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.writable">[docs]</a>    <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns if file descriptor for the current thread is writable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">writable</span><span class="p">(</span><span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="FileThreadDispatcher.writelines"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.FileThreadDispatcher.writelines">[docs]</a>    <span class="k">def</span> <span class="nf">writelines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes lines for the file descriptor for the current thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">writelines</span><span class="p">()</span></div></div>


<span class="c1"># These should NOT be lazy since they *need* to get the true stdout from the</span>
<span class="c1"># main thread. Also their creation time should be negligible.</span>
<span class="n">STDOUT_DISPATCHER</span> <span class="o">=</span> <span class="n">FileThreadDispatcher</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
<span class="n">STDERR_DISPATCHER</span> <span class="o">=</span> <span class="n">FileThreadDispatcher</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>


<div class="viewcode-block" id="parse_proxy_return"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.parse_proxy_return">[docs]</a><span class="k">def</span> <span class="nf">parse_proxy_return</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Proxies may return a variety of outputs. This handles them generally.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r : tuple, str, int, or None</span>
<span class="sd">        Return from proxy function</span>
<span class="sd">    stdout : file-like</span>
<span class="sd">        Current stdout stream</span>
<span class="sd">    stdout : file-like</span>
<span class="sd">        Current stderr stream</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cmd_result : int</span>
<span class="sd">        The return code of the proxy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">cmd_result</span> <span class="o">=</span> <span class="n">r</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
        <span class="n">rlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rlen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rlen</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rlen</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmd_result</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># for the random object...</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cmd_result</span></div>


<div class="viewcode-block" id="proxy_zero"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.proxy_zero">[docs]</a><span class="k">def</span> <span class="nf">proxy_zero</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls a proxy function which takes no parameters.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">()</span></div>


<div class="viewcode-block" id="proxy_one"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.proxy_one">[docs]</a><span class="k">def</span> <span class="nf">proxy_one</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls a proxy function which takes one parameter: args&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="proxy_two"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.proxy_two">[docs]</a><span class="k">def</span> <span class="nf">proxy_two</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls a proxy function which takes two parameter: args and stdin.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span></div>


<div class="viewcode-block" id="proxy_three"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.proxy_three">[docs]</a><span class="k">def</span> <span class="nf">proxy_three</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls a proxy function which takes three parameter: args, stdin, stdout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span></div>


<div class="viewcode-block" id="proxy_four"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.proxy_four">[docs]</a><span class="k">def</span> <span class="nf">proxy_four</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls a proxy function which takes four parameter: args, stdin, stdout,</span>
<span class="sd">    and stderr.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span></div>


<div class="viewcode-block" id="proxy_five"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.proxy_five">[docs]</a><span class="k">def</span> <span class="nf">proxy_five</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls a proxy function which takes four parameter: args, stdin, stdout,</span>
<span class="sd">    stderr, and spec.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span></div>


<span class="n">PROXIES</span> <span class="o">=</span> <span class="p">(</span><span class="n">proxy_zero</span><span class="p">,</span> <span class="n">proxy_one</span><span class="p">,</span> <span class="n">proxy_two</span><span class="p">,</span> <span class="n">proxy_three</span><span class="p">,</span> <span class="n">proxy_four</span><span class="p">,</span> <span class="n">proxy_five</span><span class="p">)</span>
<span class="n">PROXY_KWARG_NAMES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="s2">&quot;stdin&quot;</span><span class="p">,</span> <span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="s2">&quot;spec&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">])</span>


<div class="viewcode-block" id="partial_proxy"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.partial_proxy">[docs]</a><span class="k">def</span> <span class="nf">partial_proxy</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dispatches the appropriate proxy function based on the number of args.&quot;&quot;&quot;</span>
    <span class="n">numargs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span>
            <span class="ow">or</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span>
        <span class="p">):</span>
            <span class="n">numargs</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">PROXY_KWARG_NAMES</span> <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">KEYWORD_ONLY</span><span class="p">:</span>
            <span class="n">numargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">numargs</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">PROXIES</span><span class="p">[</span><span class="n">numargs</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">numargs</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="c1"># don&#39;t need to partial.</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Expected proxy with 6 or fewer arguments for </span><span class="si">{}</span><span class="s2">, not </span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="n">XonshError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROXY_KWARG_NAMES</span><span class="p">),</span> <span class="n">numargs</span><span class="p">))</span></div>


<div class="viewcode-block" id="ProcProxyThread"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.ProcProxyThread">[docs]</a><span class="k">class</span> <span class="nc">ProcProxyThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing a function to be run as a subprocess-mode command.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">f</span><span class="p">,</span>
        <span class="n">args</span><span class="p">,</span>
        <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : function</span>
<span class="sd">            The function to be executed.</span>
<span class="sd">        args : list</span>
<span class="sd">            A (possibly empty) list containing the arguments that were given on</span>
<span class="sd">            the command line</span>
<span class="sd">        stdin : file-like, optional</span>
<span class="sd">            A file-like object representing stdin (input can be read from</span>
<span class="sd">            here).  If `stdin` is not provided or if it is explicitly set to</span>
<span class="sd">            `None`, then an instance of `io.StringIO` representing an empty</span>
<span class="sd">            file is used.</span>
<span class="sd">        stdout : file-like, optional</span>
<span class="sd">            A file-like object representing stdout (normal output can be</span>
<span class="sd">            written here).  If `stdout` is not provided or if it is explicitly</span>
<span class="sd">            set to `None`, then `sys.stdout` is used.</span>
<span class="sd">        stderr : file-like, optional</span>
<span class="sd">            A file-like object representing stderr (error output can be</span>
<span class="sd">            written here).  If `stderr` is not provided or if it is explicitly</span>
<span class="sd">            set to `None`, then `sys.stderr` is used.</span>
<span class="sd">        universal_newlines : bool, optional</span>
<span class="sd">            Whether or not to use universal newlines.</span>
<span class="sd">        env : Mapping, optional</span>
<span class="sd">            Environment mapping.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">partial_proxy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed_handle_cache</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">handles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_handles</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p2cread</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p2cwrite</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c2pread</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c2pwrite</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errread</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errwrite</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">handles</span>

        <span class="c1"># default values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">stdin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span> <span class="ow">or</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2cwrite</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p2cwrite</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">open_osfhandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p2cwrite</span><span class="o">.</span><span class="n">Detach</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2pread</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c2pread</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">open_osfhandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2pread</span><span class="o">.</span><span class="n">Detach</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errread</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errread</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">open_osfhandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errread</span><span class="o">.</span><span class="n">Detach</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2cwrite</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p2cwrite</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">universal_newlines</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">write_through</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">line_buffering</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">stdin</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2pread</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2pread</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">universal_newlines</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errread</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errread</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">universal_newlines</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="c1"># Set some signal handles, if we can. Must come before process</span>
        <span class="c1"># is started to prevent deadlock on windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_int_handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">on_main_thread</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_int_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_int</span><span class="p">)</span>
        <span class="c1"># start up the proc</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_sigint</span><span class="p">()</span>

<div class="viewcode-block" id="ProcProxyThread.run"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.ProcProxyThread.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up input/output streams and execute the child function in a new</span>
<span class="sd">        thread.  This is part of the `threading.Thread` interface and should</span>
<span class="sd">        not be called directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_and_getattr</span><span class="p">(</span><span class="s2">&quot;spec&quot;</span><span class="p">)</span>
        <span class="n">last_in_pipeline</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">last_in_pipeline</span>
        <span class="k">if</span> <span class="n">last_in_pipeline</span><span class="p">:</span>
            <span class="n">capout</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">captured_stdout</span>  <span class="c1"># NOQA</span>
            <span class="n">caperr</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">captured_stderr</span>  <span class="c1"># NOQA</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2cread</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p2cread</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">open_osfhandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p2cread</span><span class="o">.</span><span class="n">Detach</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2pwrite</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">open_osfhandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2pwrite</span><span class="o">.</span><span class="n">Detach</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errwrite</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errwrite</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">open_osfhandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errwrite</span><span class="o">.</span><span class="n">Detach</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># get stdin</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sp_stdin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2cread</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">sp_stdin</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span>
                <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p2cread</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sp_stdin</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
        <span class="c1"># stdout</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2pwrite</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">sp_stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span>
                <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2pwrite</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sp_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="c1"># stderr</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errwrite</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2pwrite</span><span class="p">:</span>
            <span class="n">sp_stderr</span> <span class="o">=</span> <span class="n">sp_stdout</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">errwrite</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">sp_stderr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span>
                <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errwrite</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sp_stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
        <span class="c1"># run the function itself</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">STDOUT_DISPATCHER</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sp_stdout</span><span class="p">),</span> <span class="n">STDERR_DISPATCHER</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
                <span class="n">sp_stderr</span>
            <span class="p">),</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">STDOUT_DISPATCHER</span><span class="p">),</span> <span class="n">redirect_stderr</span><span class="p">(</span><span class="n">STDERR_DISPATCHER</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">sp_stdin</span><span class="p">,</span> <span class="n">sp_stdout</span><span class="p">,</span> <span class="n">sp_stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">still_writable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2pwrite</span><span class="p">)</span> <span class="ow">and</span> <span class="n">still_writable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errwrite</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="c1"># stdout and stderr are still writable, so error must</span>
                <span class="c1"># come from function itself.</span>
                <span class="n">print_exception</span><span class="p">()</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># stdout and stderr are no longer writable, so error must</span>
                <span class="c1"># come from the fact that the next process in the pipeline</span>
                <span class="c1"># has closed the other side of the pipe. The function then</span>
                <span class="c1"># attempted to write to this side of the pipe anyway. This</span>
                <span class="c1"># is not truly an error and we should exit gracefully.</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">print_exception</span><span class="p">()</span>
            <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">safe_flush</span><span class="p">(</span><span class="n">sp_stdout</span><span class="p">)</span>
        <span class="n">safe_flush</span><span class="p">(</span><span class="n">sp_stderr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">parse_proxy_return</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">sp_stdout</span><span class="p">,</span> <span class="n">sp_stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_in_pipeline</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
            <span class="c1"># mac requires us *not to* close the handles here while</span>
            <span class="c1"># windows requires us *to* close the handles here</span>
            <span class="k">return</span>
        <span class="c1"># clean up</span>
        <span class="c1"># scopz: not sure why this is needed, but stdin cannot go here</span>
        <span class="c1"># and stdout &amp; stderr must.</span>
        <span class="n">handles</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">:</span>
            <span class="n">safe_fdclose</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_closed_handle_cache</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_wait_and_getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;make sure the instance has a certain attr, and return it.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1e-7</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="ProcProxyThread.poll"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.ProcProxyThread.poll">[docs]</a>    <span class="k">def</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the function has completed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None if the function is still executing, and the returncode otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span></div>

<div class="viewcode-block" id="ProcProxyThread.wait"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.ProcProxyThread.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Waits for the process to finish and returns the return code.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_sigint</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span></div>

    <span class="c1">#</span>
    <span class="c1"># SIGINT handler</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_signal_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Signal handler for SIGINT - Ctrl+C may have been pressed.&quot;&quot;&quot;</span>
        <span class="c1"># Check if we have already been interrupted. This should prevent</span>
        <span class="c1"># the possibility of infinite recursion.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># close file handles here to stop an processes piped to us.</span>
        <span class="n">handles</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p2cread</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p2cwrite</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c2pread</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c2pwrite</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errread</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errwrite</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">:</span>
            <span class="n">safe_fdclose</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_sigint</span><span class="p">(</span><span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">on_main_thread</span><span class="p">():</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">pthread_kill</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(),</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_restore_sigint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_int_handler</span>
        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">on_main_thread</span><span class="p">():</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_int_handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_int</span><span class="p">:</span>
                <span class="n">old</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># The code below (_get_devnull, _get_handles, and _make_inheritable) comes</span>
    <span class="c1"># from subprocess.py in the Python 3.4.2 Standard Library</span>
    <span class="k">def</span> <span class="nf">_get_devnull</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_devnull&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_devnull</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_devnull</span>

    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">_make_inheritable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Return a duplicate of handle, which is inheritable&quot;&quot;&quot;</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">DuplicateHandle</span><span class="p">(</span>
                <span class="n">_winapi</span><span class="o">.</span><span class="n">GetCurrentProcess</span><span class="p">(),</span>
                <span class="n">handle</span><span class="p">,</span>
                <span class="n">_winapi</span><span class="o">.</span><span class="n">GetCurrentProcess</span><span class="p">(),</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="n">_winapi</span><span class="o">.</span><span class="n">DUPLICATE_SAME_ACCESS</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">Handle</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_handles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Construct and return tuple with IO objects:</span>
<span class="sd">            p2cread, p2cwrite, c2pread, c2pwrite, errread, errwrite</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">stdin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">p2cread</span><span class="p">,</span> <span class="n">p2cwrite</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">c2pread</span><span class="p">,</span> <span class="n">c2pwrite</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">errread</span><span class="p">,</span> <span class="n">errwrite</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">if</span> <span class="n">stdin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">p2cread</span> <span class="o">=</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">GetStdHandle</span><span class="p">(</span><span class="n">_winapi</span><span class="o">.</span><span class="n">STD_INPUT_HANDLE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p2cread</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p2cread</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">CreatePipe</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">p2cread</span> <span class="o">=</span> <span class="n">Handle</span><span class="p">(</span><span class="n">p2cread</span><span class="p">)</span>
                    <span class="n">_winapi</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">stdin</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">:</span>
                <span class="n">p2cread</span><span class="p">,</span> <span class="n">p2cwrite</span> <span class="o">=</span> <span class="n">Handle</span><span class="p">(</span><span class="n">p2cread</span><span class="p">),</span> <span class="n">Handle</span><span class="p">(</span><span class="n">p2cwrite</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">stdin</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">:</span>
                <span class="n">p2cread</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">get_osfhandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_devnull</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">p2cread</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">get_osfhandle</span><span class="p">(</span><span class="n">stdin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assuming file-like object</span>
                <span class="n">p2cread</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">get_osfhandle</span><span class="p">(</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
            <span class="n">p2cread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_inheritable</span><span class="p">(</span><span class="n">p2cread</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">GetStdHandle</span><span class="p">(</span><span class="n">_winapi</span><span class="o">.</span><span class="n">STD_OUTPUT_HANDLE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c2pwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">CreatePipe</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">Handle</span><span class="p">(</span><span class="n">c2pwrite</span><span class="p">)</span>
                    <span class="n">_winapi</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">stdout</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">:</span>
                <span class="n">c2pread</span><span class="p">,</span> <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">CreatePipe</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">c2pread</span><span class="p">,</span> <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">Handle</span><span class="p">(</span><span class="n">c2pread</span><span class="p">),</span> <span class="n">Handle</span><span class="p">(</span><span class="n">c2pwrite</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">stdout</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">:</span>
                <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">get_osfhandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_devnull</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">get_osfhandle</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assuming file-like object</span>
                <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">get_osfhandle</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
            <span class="n">c2pwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_inheritable</span><span class="p">(</span><span class="n">c2pwrite</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">errwrite</span> <span class="o">=</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">GetStdHandle</span><span class="p">(</span><span class="n">_winapi</span><span class="o">.</span><span class="n">STD_ERROR_HANDLE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">errwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">errwrite</span> <span class="o">=</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">CreatePipe</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">errwrite</span> <span class="o">=</span> <span class="n">Handle</span><span class="p">(</span><span class="n">errwrite</span><span class="p">)</span>
                    <span class="n">_winapi</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">stderr</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">:</span>
                <span class="n">errread</span><span class="p">,</span> <span class="n">errwrite</span> <span class="o">=</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">CreatePipe</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">errread</span><span class="p">,</span> <span class="n">errwrite</span> <span class="o">=</span> <span class="n">Handle</span><span class="p">(</span><span class="n">errread</span><span class="p">),</span> <span class="n">Handle</span><span class="p">(</span><span class="n">errwrite</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">stderr</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">:</span>
                <span class="n">errwrite</span> <span class="o">=</span> <span class="n">c2pwrite</span>
            <span class="k">elif</span> <span class="n">stderr</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">:</span>
                <span class="n">errwrite</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">get_osfhandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_devnull</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">errwrite</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">get_osfhandle</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assuming file-like object</span>
                <span class="n">errwrite</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">get_osfhandle</span><span class="p">(</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
            <span class="n">errwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_inheritable</span><span class="p">(</span><span class="n">errwrite</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">p2cread</span><span class="p">,</span> <span class="n">p2cwrite</span><span class="p">,</span> <span class="n">c2pread</span><span class="p">,</span> <span class="n">c2pwrite</span><span class="p">,</span> <span class="n">errread</span><span class="p">,</span> <span class="n">errwrite</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># POSIX versions</span>
        <span class="k">def</span> <span class="nf">_get_handles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Construct and return tuple with IO objects:</span>
<span class="sd">            p2cread, p2cwrite, c2pread, c2pwrite, errread, errwrite</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p2cread</span><span class="p">,</span> <span class="n">p2cwrite</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">c2pread</span><span class="p">,</span> <span class="n">c2pwrite</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">errread</span><span class="p">,</span> <span class="n">errwrite</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">if</span> <span class="n">stdin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">stdin</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">:</span>
                <span class="n">p2cread</span><span class="p">,</span> <span class="n">p2cwrite</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">stdin</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">:</span>
                <span class="n">p2cread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_devnull</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">p2cread</span> <span class="o">=</span> <span class="n">stdin</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assuming file-like object</span>
                <span class="n">p2cread</span> <span class="o">=</span> <span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">stdout</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">:</span>
                <span class="n">c2pread</span><span class="p">,</span> <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">stdout</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">:</span>
                <span class="n">c2pwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_devnull</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">stdout</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assuming file-like object</span>
                <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">stderr</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">:</span>
                <span class="n">errread</span><span class="p">,</span> <span class="n">errwrite</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">stderr</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">:</span>
                <span class="n">errwrite</span> <span class="o">=</span> <span class="n">c2pwrite</span>
            <span class="k">elif</span> <span class="n">stderr</span> <span class="o">==</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">:</span>
                <span class="n">errwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_devnull</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">errwrite</span> <span class="o">=</span> <span class="n">stderr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assuming file-like object</span>
                <span class="n">errwrite</span> <span class="o">=</span> <span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">p2cread</span><span class="p">,</span> <span class="n">p2cwrite</span><span class="p">,</span> <span class="n">c2pread</span><span class="p">,</span> <span class="n">c2pwrite</span><span class="p">,</span> <span class="n">errread</span><span class="p">,</span> <span class="n">errwrite</span><span class="p">)</span></div>


<span class="c1">#</span>
<span class="c1"># Foreground Thread Process Proxies</span>
<span class="c1">#</span>


<div class="viewcode-block" id="ProcProxy"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.ProcProxy">[docs]</a><span class="k">class</span> <span class="nc">ProcProxy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is process proxy class that runs its alias functions on the</span>
<span class="sd">    same thread that it was called from, which is typically the main thread.</span>
<span class="sd">    This prevents the process from running on a background thread, but enables</span>
<span class="sd">    debugger and profiler tools (functions) be run on the same thread that they</span>
<span class="sd">    are attempting to debug.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">f</span><span class="p">,</span>
        <span class="n">args</span><span class="p">,</span>
        <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">partial_proxy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">stdin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universal_newlines</span> <span class="o">=</span> <span class="n">universal_newlines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>

<div class="viewcode-block" id="ProcProxy.poll"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.ProcProxy.poll">[docs]</a>    <span class="k">def</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the function has completed via the returncode or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span></div>

<div class="viewcode-block" id="ProcProxy.wait"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.ProcProxy.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the function and returns the result. Timeout argument only</span>
<span class="sd">        present for API compatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_and_getattr</span><span class="p">(</span><span class="s2">&quot;spec&quot;</span><span class="p">)</span>
        <span class="c1"># set file handles</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">inbuf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inbuf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span>
            <span class="n">stdin</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">inbuf</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pick_buf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">enc</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pick_buf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">enc</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="c1"># run the actual function</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">print_exception</span><span class="p">()</span>
            <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">parse_proxy_return</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="n">safe_flush</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">safe_flush</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_pick_buf</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">sysbuf</span><span class="p">,</span> <span class="n">enc</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">handle</span> <span class="ow">is</span> <span class="n">sysbuf</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">sysbuf</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">handle</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">sysbuf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span>
                    <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;encoding&quot;</span><span class="p">):</span>
            <span class="c1"># must be a text stream, no need to wrap.</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">handle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># must be a binary stream, should wrap it.</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">buf</span>

    <span class="k">def</span> <span class="nf">_wait_and_getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;make sure the instance has a certain attr, and return it.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1e-7</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">SIGNAL_MESSAGES</span><span class="p">():</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">SIGABRT</span><span class="p">:</span> <span class="s2">&quot;Aborted&quot;</span><span class="p">,</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">SIGFPE</span><span class="p">:</span> <span class="s2">&quot;Floating point exception&quot;</span><span class="p">,</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">SIGILL</span><span class="p">:</span> <span class="s2">&quot;Illegal instructions&quot;</span><span class="p">,</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">:</span> <span class="s2">&quot;Terminated&quot;</span><span class="p">,</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">SIGSEGV</span><span class="p">:</span> <span class="s2">&quot;Segmentation fault&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">ON_POSIX</span><span class="p">:</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGQUIT</span><span class="p">:</span> <span class="s2">&quot;Quit&quot;</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">:</span> <span class="s2">&quot;Hangup&quot;</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">:</span> <span class="s2">&quot;Killed&quot;</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">sm</span>


<div class="viewcode-block" id="safe_readlines"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.safe_readlines">[docs]</a><span class="k">def</span> <span class="nf">safe_readlines</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">hint</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attempts to read lines without throwing an error.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">lines</span></div>


<div class="viewcode-block" id="safe_readable"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.safe_readable">[docs]</a><span class="k">def</span> <span class="nf">safe_readable</span><span class="p">(</span><span class="n">handle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attempts to find if the handle is readable without throwing an error.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">readable</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">status</span></div>


<div class="viewcode-block" id="update_fg_process_group"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.update_fg_process_group">[docs]</a><span class="k">def</span> <span class="nf">update_fg_process_group</span><span class="p">(</span><span class="n">pipeline_group</span><span class="p">,</span> <span class="n">background</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ON_POSIX</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_INTERACTIVE&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">give_terminal_to</span><span class="p">(</span><span class="n">pipeline_group</span><span class="p">)</span></div>


<div class="viewcode-block" id="CommandPipeline"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.CommandPipeline">[docs]</a><span class="k">class</span> <span class="nc">CommandPipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a subprocess-mode command pipeline.&quot;&quot;&quot;</span>

    <span class="n">attrnames</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;stdin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stdout&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stderr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;returncode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="s2">&quot;alias&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stdin_redirect&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stdout_redirect&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stderr_redirect&quot;</span><span class="p">,</span>
        <span class="s2">&quot;timestamps&quot;</span><span class="p">,</span>
        <span class="s2">&quot;executed_cmd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;input&quot;</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">,</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">nonblocking</span> <span class="o">=</span> <span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">,</span> <span class="n">NonBlockingFDReader</span><span class="p">,</span> <span class="n">ConsoleParallelReader</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        specs : list of SubprocSpec</span>
<span class="sd">            Process specifications</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        spec : SubprocSpec</span>
<span class="sd">            The last specification in specs</span>
<span class="sd">        proc : Popen-like</span>
<span class="sd">            The process in procs</span>
<span class="sd">        ended : bool</span>
<span class="sd">            Boolean for if the command has stopped executing.</span>
<span class="sd">        input : str</span>
<span class="sd">            A string of the standard input.</span>
<span class="sd">        output : str</span>
<span class="sd">            A string of the standard output.</span>
<span class="sd">        errors : str</span>
<span class="sd">            A string of the standard error.</span>
<span class="sd">        lines : list of str</span>
<span class="sd">            The output lines</span>
<span class="sd">        starttime : floats or None</span>
<span class="sd">            Pipeline start timestamp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starttime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ended</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specs</span> <span class="o">=</span> <span class="n">specs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">captured</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">captured</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endtime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed_handle_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_postfix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_pgid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">background</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">background</span>
        <span class="n">pipeline_group</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">starttime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">pipeline_group</span><span class="o">=</span><span class="n">pipeline_group</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">print_exception</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_return_terminal</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">pid</span>
                <span class="ow">and</span> <span class="n">pipeline_group</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">is_proxy</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">captured</span> <span class="o">!=</span> <span class="s2">&quot;object&quot;</span>
            <span class="p">):</span>
                <span class="n">pipeline_group</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span>
                <span class="k">if</span> <span class="n">update_fg_process_group</span><span class="p">(</span><span class="n">pipeline_group</span><span class="p">,</span> <span class="n">background</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">term_pgid</span> <span class="o">=</span> <span class="n">pipeline_group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrnames</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterates through stdout and returns the lines, converting to</span>
<span class="sd">        strings and universal newlines if needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ended</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">tee_stdout</span><span class="p">()</span>

<div class="viewcode-block" id="CommandPipeline.iterraw"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.CommandPipeline.iterraw">[docs]</a>    <span class="k">def</span> <span class="nf">iterraw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterates through the last stdout, and returns the lines</span>
<span class="sd">        exactly as found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get appropriate handles</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span>
        <span class="k">if</span> <span class="n">proc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_PROC_FREQUENCY&quot;</span><span class="p">)</span>
        <span class="c1"># get the correct stdout</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">stdout</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">safe_readable</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">captured_stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">captured_stdout</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;buffer&quot;</span><span class="p">):</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span>
        <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonblocking</span><span class="p">):</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">NonBlockingFDReader</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">stdout</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">captured</span> <span class="o">==</span> <span class="s2">&quot;stdout&quot;</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">safe_readable</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">threadable</span>
        <span class="p">):</span>
            <span class="c1"># we get here if the process is not threadable or the</span>
            <span class="c1"># class is the real Popen</span>
            <span class="n">PrevProcCloser</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">wait_for_active_job</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;stopped&quot;</span><span class="p">:</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_endtime</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">captured</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">tee_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">captured</span> <span class="o">==</span> <span class="s2">&quot;hiddenobject&quot;</span> <span class="ow">and</span> <span class="n">stdout</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">yield from</span> <span class="n">lines</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">tee_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">captured</span> <span class="o">==</span> <span class="s2">&quot;stdout&quot;</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_uninew</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># get the correct stderr</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">stderr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">safe_readable</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">captured_stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">captured_stderr</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;buffer&quot;</span><span class="p">):</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span><span class="o">.</span><span class="n">buffer</span>
        <span class="k">if</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonblocking</span><span class="p">):</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="n">NonBlockingFDReader</span><span class="p">(</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="c1"># read from process while it is running</span>
        <span class="n">check_prev_done</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">prev_end_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="s2">&quot;in_alt_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># probably not leaving any time soon</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">check_prev_done</span><span class="p">:</span>
                <span class="c1"># In the case of pipelines with more than one command</span>
                <span class="c1"># we should give the commands a little time</span>
                <span class="c1"># to start up fully. This is particularly true for</span>
                <span class="c1"># GNU Parallel, which has a long startup time.</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prev_procs_done</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_close_prev_procs</span><span class="p">()</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">prevs_are_closed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="n">stdout_lines</span> <span class="o">=</span> <span class="n">safe_readlines</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stdout_lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">stdout_lines</span>
            <span class="n">stderr_lines</span> <span class="o">=</span> <span class="n">safe_readlines</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stderr_lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream_stderr</span><span class="p">(</span><span class="n">stderr_lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_prev_done</span><span class="p">:</span>
                <span class="c1"># if we are piping...</span>
                <span class="k">if</span> <span class="n">stdout_lines</span> <span class="ow">or</span> <span class="n">stderr_lines</span><span class="p">:</span>
                    <span class="c1"># see if we have some output.</span>
                    <span class="n">check_prev_done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">prev_end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># or see if we already know that the next-to-last</span>
                    <span class="c1"># proc in the pipeline has ended.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prev_procs_done</span><span class="p">():</span>
                        <span class="c1"># if it has, record the time</span>
                        <span class="n">prev_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">prev_end_time</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="c1"># if we still don&#39;t have any output, even though the</span>
                    <span class="c1"># next-to-last proc has finished, wait a bit to make</span>
                    <span class="c1"># sure we have fully started up, etc.</span>
                    <span class="n">check_prev_done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># this is for CPU usage</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span> <span class="o">*</span> <span class="n">cnt</span><span class="p">)</span>
        <span class="c1"># read from process now that it is over</span>
        <span class="k">yield from</span> <span class="n">safe_readlines</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_stderr</span><span class="p">(</span><span class="n">safe_readlines</span><span class="p">(</span><span class="n">stderr</span><span class="p">))</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_endtime</span><span class="p">()</span>
        <span class="k">yield from</span> <span class="n">safe_readlines</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_stderr</span><span class="p">(</span><span class="n">safe_readlines</span><span class="p">(</span><span class="n">stderr</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">captured</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">tee_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="CommandPipeline.itercheck"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.CommandPipeline.itercheck">[docs]</a>    <span class="k">def</span> <span class="nf">itercheck</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterates through the command lines and throws an error if the</span>
<span class="sd">        returncode is non-zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
            <span class="c1"># I included self, as providing access to stderr and other details</span>
            <span class="c1"># useful when instance isn&#39;t assigned to a variable in the shell.</span>
            <span class="k">raise</span> <span class="n">XonshCalledProcessError</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed_cmd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">self</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="CommandPipeline.tee_stdout"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.CommandPipeline.tee_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">tee_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes the process stdout to the output variable, line-by-line, and</span>
<span class="sd">        yields each line. This may optionally accept lines (in bytes) to iterate</span>
<span class="sd">        over, in which case it does not call iterraw().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captured</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">STDOUT_CAPTURE_KINDS</span>
        <span class="k">if</span> <span class="n">stream</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">stdout_has_buffer</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;buffer&quot;</span><span class="p">)</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span>
        <span class="n">crnl</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterraw</span><span class="p">():</span>
            <span class="c1"># write to stdout line ASAP, if needed</span>
            <span class="k">if</span> <span class="n">stream</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stdout_has_buffer</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c1"># do some munging of the line before we return it</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">crnl</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">nl</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">cr</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">nl</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">RE_HIDE_ESCAPE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
            <span class="c1"># tee it up!</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">line</span></div>

<div class="viewcode-block" id="CommandPipeline.stream_stderr"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.CommandPipeline.stream_stderr">[docs]</a>    <span class="k">def</span> <span class="nf">stream_stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Streams lines to sys.stderr and the errors attribute.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_prefix</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_prefix</span> <span class="o">+</span> <span class="n">b</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_postfix</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_postfix</span>
        <span class="n">stderr_has_buffer</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;buffer&quot;</span><span class="p">)</span>
        <span class="c1"># write bytes to std stream</span>
        <span class="k">if</span> <span class="n">stderr_has_buffer</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="c1"># do some munging of the line before we save it to the attr</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">RE_HIDE_ESCAPE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">),</span> <span class="n">errors</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># set the errors</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="n">s</span></div>

    <span class="k">def</span> <span class="nf">_decode_uninew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decode bytes into a str and apply universal newlines as needed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">encoding</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">),</span>
                <span class="n">errors</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">b</span>
        <span class="k">if</span> <span class="n">universal_newlines</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">universal_newlines</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="c1">#</span>
    <span class="c1"># Ending methods</span>
    <span class="c1">#</span>

<div class="viewcode-block" id="CommandPipeline.end"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.CommandPipeline.end">[docs]</a>    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tee_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        End the pipeline, return the controlling terminal if needed.</span>

<span class="sd">        Main things done in self._end().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ended</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end</span><span class="p">(</span><span class="n">tee_output</span><span class="o">=</span><span class="n">tee_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_terminal</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tee_output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Waits for the command to complete and then runs any closing and</span>
<span class="sd">        cleanup procedures that need to be run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tee_output</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tee_stdout</span><span class="p">():</span>
                <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_endtime</span><span class="p">()</span>
        <span class="c1"># since we are driven by getting output, input may not be available</span>
        <span class="c1"># until the command has completed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_prev_procs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_proc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_signal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_to_history</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ended</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_subproc_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_return_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ON_POSIX</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">pgid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpgid</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">term_pgid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pgid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">term_pgid</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">give_terminal_to</span><span class="p">(</span><span class="n">pgid</span><span class="p">):</span>  <span class="c1"># if gave term succeed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_pgid</span> <span class="o">=</span> <span class="n">pgid</span>
            <span class="k">if</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">shell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># restoring sanity could probably be called whenever we return</span>
                <span class="c1"># control to the shell. But it only seems to matter after a</span>
                <span class="c1"># ^Z event. This *has* to be called after we give the terminal</span>
                <span class="c1"># back to the shell.</span>
                <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">restore_tty_sanity</span><span class="p">()</span>

<div class="viewcode-block" id="CommandPipeline.resume"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.CommandPipeline.resume">[docs]</a>    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">tee_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ended</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">give_terminal_to</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;pgrp&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">term_pgid</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;pgrp&quot;</span><span class="p">]</span>
        <span class="n">_continue</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">tee_output</span><span class="o">=</span><span class="n">tee_output</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_endtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the closing timestamp if it hasn&#39;t been already.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endtime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_safe_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
        <span class="n">safe_fdclose</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_closed_handle_cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prev_procs_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean for if all previous processes have completed. If there</span>
<span class="sd">        is only a single process in the pipeline, this returns False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">any_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">any_running</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">any_running</span> <span class="k">else</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_close_prev_procs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes all but the last proc&#39;s stdout.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_close_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes last proc&#39;s stdout.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">captured_stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">captured_stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the input variable.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">stdin</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">stdin</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">stdin</span><span class="o">.</span><span class="n">closed</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">stdin</span><span class="o">.</span><span class="n">seekable</span><span class="p">()</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">safe_readable</span><span class="p">(</span><span class="n">stdin</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stdin</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_uninew</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if a signal was received and issues a message.&quot;&quot;&quot;</span>
        <span class="n">proc_signal</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="p">,</span> <span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proc_signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">sig</span><span class="p">,</span> <span class="n">core</span> <span class="o">=</span> <span class="n">proc_signal</span>
        <span class="n">sig_str</span> <span class="o">=</span> <span class="n">SIGNAL_MESSAGES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sig_str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">core</span><span class="p">:</span>
                <span class="n">sig_str</span> <span class="o">+=</span> <span class="s2">&quot; (core dumped)&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sig_str</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="n">sig_str</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_apply_to_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Applies the results to the current history object.&quot;&quot;&quot;</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">history</span>
        <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">last_cmd_rtn</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span>

    <span class="k">def</span> <span class="nf">_raise_subproc_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raises a subprocess error, if we are supposed to.&quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">is_proxy</span>
            <span class="ow">and</span> <span class="n">rtn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">rtn</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RAISE_SUBPROC_ERROR&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">(</span><span class="n">rtn</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># this is need to get a working terminal in interactive mode</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_return_terminal</span><span class="p">()</span>

    <span class="c1">#</span>
    <span class="c1"># Properties</span>
    <span class="c1">#</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process stdin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">stdin</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process stdout.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process stderr.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">stderr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates normalized input string from args.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Non-blocking, lazy access to output&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ended</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Output value as a str.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">err</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Error messages as a string.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process identifier.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">returncode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process return code, waits until command is completed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span>

    <span class="n">rtn</span> <span class="o">=</span> <span class="n">returncode</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Arguments to the process.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rtn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias to return code.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias the process used.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">alias</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stdin_redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Redirection used for stdin.&quot;&quot;&quot;</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">stdin</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stdout_redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Redirection used for stdout.&quot;&quot;&quot;</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;stdout&gt;&quot;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stderr_redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Redirection used for stderr.&quot;&quot;&quot;</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;stderr&gt;&quot;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timestamps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The start and end time stamps.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endtime</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">executed_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The resolve and executed command.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">cmd</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stderr_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prefix to print in front of stderr, as bytes.&quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_prefix</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_STDERR_PREFIX&quot;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">format_std_prepost</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="n">encoding</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">),</span>
                <span class="n">errors</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_prefix</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stderr_postfix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Postfix to print after stderr, as bytes.&quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_postfix</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_STDERR_POSTFIX&quot;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">format_std_prepost</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="n">encoding</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">),</span>
                <span class="n">errors</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_postfix</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">return</span> <span class="n">p</span></div>


<div class="viewcode-block" id="HiddenCommandPipeline"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.HiddenCommandPipeline">[docs]</a><span class="k">class</span> <span class="nc">HiddenCommandPipeline</span><span class="p">(</span><span class="n">CommandPipeline</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="pause_call_resume"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.pause_call_resume">[docs]</a><span class="k">def</span> <span class="nf">pause_call_resume</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For a process p, this will call a function f with the remaining args and</span>
<span class="sd">    and kwargs. If the process cannot accept signals, the function will be called.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p : Popen object or similar</span>
<span class="sd">    f : callable</span>
<span class="sd">    args : remaining arguments</span>
<span class="sd">    kwargs : keyword arguments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">can_send_signal</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;send_signal&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ON_POSIX</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ON_MSYS</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ON_CYGWIN</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">can_send_signal</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGSTOP</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">can_send_signal</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCONT</span><span class="p">)</span></div>


<div class="viewcode-block" id="PrevProcCloser"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.PrevProcCloser">[docs]</a><span class="k">class</span> <span class="nc">PrevProcCloser</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Previous process closer thread for pipelines whose last command</span>
<span class="sd">    is itself unthreadable. This makes sure that the pipeline is</span>
<span class="sd">    driven forward and does not deadlock.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pipeline : CommandPipeline</span>
<span class="sd">            The pipeline whose prev procs we should close.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<div class="viewcode-block" id="PrevProcCloser.run"><a class="viewcode-back" href="../../api/proc.html#xonsh.proc.PrevProcCloser.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the closing algorithm.&quot;&quot;&quot;</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span>
        <span class="n">check_prev_done</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">procs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">check_prev_done</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">proc</span>
        <span class="n">prev_end_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__xonsh__</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_PROC_FREQUENCY&quot;</span><span class="p">)</span>
        <span class="n">sleeptime</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_prev_done</span><span class="p">:</span>
                <span class="c1"># In the case of pipelines with more than one command</span>
                <span class="c1"># we should give the commands a little time</span>
                <span class="c1"># to start up fully. This is particularly true for</span>
                <span class="c1"># GNU Parallel, which has a long startup time.</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_prev_procs_done</span><span class="p">():</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">_close_prev_procs</span><span class="p">()</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">prevs_are_closed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_prev_done</span><span class="p">:</span>
                <span class="c1"># if we are piping...</span>
                <span class="k">if</span> <span class="n">prev_end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># or see if we already know that the next-to-last</span>
                    <span class="c1"># proc in the pipeline has ended.</span>
                    <span class="k">if</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_prev_procs_done</span><span class="p">():</span>
                        <span class="c1"># if it has, record the time</span>
                        <span class="n">prev_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">prev_end_time</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="c1"># if we still don&#39;t have any output, even though the</span>
                    <span class="c1"># next-to-last proc has finished, wait a bit to make</span>
                    <span class="c1"># sure we have fully started up, etc.</span>
                    <span class="n">check_prev_done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># this is for CPU usage</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleeptime</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../../sidebar.html" title="sidebar">
          <img class="logo" src="../../_static/ascii_conch_part_transparent_tight.png" alt="Logo"/>
        </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../sidebar.html">xonsh 0.8.5 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Anthony Scopatz.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>