<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" class="medium-up-screen translated-ltr"><head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>チュートリアル：独自のヒストリーバックエンドを書く -  xonsh 0.8.5 documentation</title>
    <link rel="stylesheet" href="_static/numpy_friendly.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="_static/cloud.base.js"></script>
    <script type="text/javascript" src="_static/cloud.js"></script>
    <link rel="shortcut icon" href="_static/magic_conch.ico" />
    <link rel="index" title="インデックス" href="genindex.html" />
    <link rel="search" title="サーチ" href="search.html" />
    <link rel="next" title="チュートリアル：サブプロセス文字列" href="tutorial_subproc_strings.html" />
    <link rel="prev" title="チュートリアル：プログラマブルタブ完成" href="tutorial_completers.html" />
     
        <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="canonical" href="http://xon.sh/tutorial_history_backend.html" />

  <link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css" /></head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ナビゲーション</font></font></h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="一般索引" accesskey="I"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">索引</font></font></a></li>
        <li class="right">
          <a href="py-modindex.html" title="Pythonモジュールのインデックス"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュール</font></font></a>    </li>
        <li class="right">
          <a href="tutorial_subproc_strings.html" title="チュートリアル：サブプロセス文字列" accesskey="N"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次</font></font></a>    </li>
        <li class="right">
          <a href="tutorial_completers.html" title="チュートリアル：プログラマブルタブ完成" accesskey="P"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前</font></font></a>    </li>
    <li><a href="sidebar.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xonsh 0.8.5 documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »</font></font></li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xonshシェル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »</font></font></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tutorial-write-your-own-history-backend">
<span id="tutorial-history-backend"></span><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チュートリアル：独自のヒストリーバックエンドを書く</font></font><a class="headerlink" href="#tutorial-write-your-own-history-backend" title="この見出しにパーマリンク"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h1>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xonshに関する素晴らしいことの1つは、カスタマイズが簡単であることです。</font><font style="vertical-align: inherit;">このチュートリアルでは、CouchDBに基づいて独自の履歴バックエンドを作成しましょう。</font></font></p>
<div class="section" id="start-with-a-minimal-history-template">
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最小履歴テンプレートで始める</font></font><a class="headerlink" href="#start-with-a-minimal-history-template" title="この見出しにパーマリンク"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここから始まる最小限の履歴バックエンドがあります：</font></font></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">xonsh.history.base</span> <span class="kn">import</span> <span class="n">History</span>

<span class="k">class</span> <span class="nc">CouchDBHistory</span><span class="p">(</span><span class="n">History</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s1">'inp'</span><span class="p">:</span> <span class="s1">'couchdb in action'</span><span class="p">,</span> <span class="s1">'ts'</span><span class="p">:</span> <span class="mi">1464652800</span><span class="p">,</span> <span class="s1">'ind'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">all_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">'backend'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'couchdb'</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">'sessionid'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sessionid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">先に進んでファイルを作成し、</font></font><code class="docutils literal notranslate"><span class="pre">~/.xonsh/history_couchdb.py</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上にコンテンツを入れてください。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これでxonshに履歴バックエンドとして使用するよう指示する必要があります。</font><font style="vertical-align: inherit;">これを行うには、ファイルとこの</font></font><code class="docutils literal notranslate"><span class="pre">CouchDBHistory</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラス</font><font style="vertical-align: inherit;">を見つけるためにxonshが必要です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">次のコードを</font></font><code class="docutils literal notranslate"><span class="pre">~/.xonshrc</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルに</font><font style="vertical-align: inherit;">入れて</font><font style="vertical-align: inherit;">これを実現できます。</font></font></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>import os.path
import sys
xonsh_ext_dir = os.path.expanduser('~/.xonsh')
if os.path.isdir(xonsh_ext_dir):
    sys.path.append(xonsh_ext_dir)

from history_couchdb import CouchDBHistory
$XONSH_HISTORY_BACKEND = CouchDBHistory
</pre></div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいxonshセッションを開始した後、次のコマンドを試してください：</font></font></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ history info
backend: couchdb
sessionid: 4198d678-1f0a-4ce3-aeb3-6d5517d7fc61

$ history -n
0: couchdb in action
</pre></div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウーホー！</font><font style="vertical-align: inherit;">私たちは作業履歴のバックエンドを書きました！</font></font></p>
</div>
<div class="section" id="setup-couchdb">
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CouchDBのセットアップ</font></font><a class="headerlink" href="#setup-couchdb" title="この見出しにパーマリンク"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これを行うには、CouchDBが稼働している必要があります。</font><font style="vertical-align: inherit;">行く
 </font></font><a class="reference external" href="http://couchdb.apache.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のCouchDBのWebサイト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、それをインストールするには、いくつかの時間を費やします。</font><font style="vertical-align: inherit;">私たちはあなたを待つでしょう。</font><font style="vertical-align: inherit;">ゆっくりしてください。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インストール後、正しく設定されていることを確認してください</font></font><code class="docutils literal notranslate"><span class="pre">curl</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ curl -i 'http://127.0.0.1:5984/'
HTTP/1.1 200 OK
Cache-Control: must-revalidate
Content-Length: 91
Content-Type: application/json
Date: Wed, 01 Feb 2017 13:54:14 GMT
Server: CouchDB/2.0.0 (Erlang OTP/19)
X-Couch-Request-ID: 025a195bcb
X-CouchDB-Body-Time: 0

{
    "couchdb": "Welcome",
    "version": "2.0.0",
    "vendor": {
        "name": "The Apache Software Foundation"
    }
}
</pre></div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さて、CouchDBは動作しています。</font><font style="vertical-align: inherit;">ブラウザで</font></font><a class="reference external" href="http://127.0.0.1:5984/_utils/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://127.0.0.1:5984/_utils/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">開い</font><font style="vertical-align: inherit;">て、新しいデータベースを作成します</font></font><code class="docutils literal notranslate"><span class="pre">xonsh-history</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></p>
</div>
<div class="section" id="initialize-history-backend">
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">履歴バックエンドの初期化</font></font><a class="headerlink" href="#initialize-history-backend" title="この見出しにパーマリンク"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gc</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sessionid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_session_id</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rtns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tss</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">_build_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'{}-{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">18</span><span class="p">])</span>
</pre></div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この</font></font><code class="docutils literal notranslate"><span class="pre">__init__()</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドでは、</font><font style="vertical-align: inherit;">
xonshがさまざまな場所で使う</font></font><a class="reference external" href="api/history/base.html#xonsh.history.base.History"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いくつかのパブリック属性</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">初期化しましょう
 </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Unixのタイムスタンプといくつかのランダムなcharを使って</font></font><code class="docutils literal notranslate"><span class="pre">self.sessionid</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユニークにし、エントリを時間順に並べておく</font><font style="vertical-align: inherit;">ことに注意してください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">次のセクションでもう少し詳しく説明します。</font></font></p>
</div>
<div class="section" id="save-history-to-couchdb">
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">履歴をCouchDBに保存する</font></font><a class="headerlink" href="#save-history-to-couchdb" title="この見出しにパーマリンク"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まず、CouchDBにドキュメントを書くためのヘルパー関数が必要です。</font></font></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_save_to_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">'inp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">'inp'</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">'out'</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'out'</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">'_id'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_doc_id</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request_db_data</span><span class="p">(</span><span class="s1">'/xonsh-history'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">'failed to save history: {}: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_build_doc_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'{}-{}-{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sessionid</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">18</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_request_db_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">'http://127.0.0.1:5984'</span> <span class="o">+</span> <span class="n">path</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'text/plain'</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">_save_to_db()</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ユーザが入力したコマンドに関する情報を含む入力をdictとし、CouchDBに保存します。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CouchDBに無作為な文書ID（</font></font><code class="docutils literal notranslate"><span class="pre">data['_id']</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード内）を</font><font style="vertical-align: inherit;">提供させるのではなく、私たち
 </font><font style="vertical-align: inherit;">自身のために構築します。</font><font style="vertical-align: inherit;">UnixタイムスタンプとUUID文字列をもう一度使用します。</font><font style="vertical-align: inherit;">これを
 </font></font><code class="docutils literal notranslate"><span class="pre">self.sessionid</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレフィックスとして、単一のxonshセッション内で順番に履歴エントリを作成します。</font><font style="vertical-align: inherit;">CouchDBの</font></font><a class="reference external" href="http://docs.couchdb.org/en/2.0.0/couchapp/ddocs.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デザインドキュメントとビュー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の追加</font><font style="vertical-align: inherit;">
機能</font><font style="vertical-align: inherit;">は必要ありません
 </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">裸の</font></font><code class="docutils literal notranslate"><span class="pre">_all_docs</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API </font><font style="vertical-align: inherit;">だけで、</font><font style="vertical-align: inherit;">履歴項目を順番に取得できます。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘルパー関数ができ</font></font><code class="docutils literal notranslate"><span class="pre">append()</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たので、実際の作業を行うメソッドを</font><font style="vertical-align: inherit;">更新しましょう</font><font style="vertical-align: inherit;">。履歴をDBに保存します。</font></font></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s1">'inp'</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rtns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s1">'rtn'</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_save_to_db</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</pre></div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このメソッドは、ユーザーから新しいコマンドを実行するたびにxonshによって呼び出されます。</font></font></p>
</div>
<div class="section" id="retrieve-history-items">
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">履歴項目を取得する</font></font><a class="headerlink" href="#retrieve-history-items" title="この見出しにパーマリンク"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_db_items</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sessionid</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">all_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_db_items</span><span class="p">()</span>
</pre></div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらの2つのメソッドは、現在のxonshセッションとすべての履歴セッションの履歴項目を取得します。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、DBからドキュメントを入手するヘルパーメソッドは次のとおりです：</font></font></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_db_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessionid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">'/xonsh-history/_all_docs?include_docs=true'</span>
    <span class="k">if</span> <span class="n">sessionid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">+=</span> <span class="s1">'&amp;start_key="{0}"&amp;end_key="{0}-z"'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sessionid</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_db_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">'error when query db: {}: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">'rows'</span><span class="p">]:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">'doc'</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">[</span><span class="s1">'ts'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">'ts'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">yield</span> <span class="n">cmd</span>
</pre></div>
</div>
<p><font style="vertical-align: inherit;"></font><cite><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">try-除く</font></font></cite><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">悪い何かが起こるときのCouchDB等、適切に実行されていないように私たちは、安全だようにここにあります</font></font></p>
</div>
<div class="section" id="try-out-our-new-history-backend">
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しい履歴のバックエンドを試してみましょう</font></font><a class="headerlink" href="#try-out-our-new-history-backend" title="この見出しにパーマリンク"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それでおしまい。</font><font style="vertical-align: inherit;">私たちは新しい歴史バックエンドを終えました。</font></font><code class="docutils literal notranslate"><span class="pre">import</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一部はスキップされますが、私はあなたががそれを把握することができると思います。</font><font style="vertical-align: inherit;">私たちのコードでは、余分なPythonライブラリが使われています：</font></font><code class="docutils literal notranslate"><span class="pre">requests</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">あなたは</font></font><code class="docutils literal notranslate"><span class="pre">pip</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他のライブラリマネージャー</font><font style="vertical-align: inherit;">と簡単にインストールできます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">フルコードは
 </font></font><a class="reference external" href="https://gist.github.com/mitnk/2d08dc60aab33d8b8b758c544b37d570"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://gist.github.com/mitnk/2d08dc60aab33d8b8b758c544b37d570でご覧いただけます。</font></font></a></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいxonshセッションを開始しましょう：</font></font></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ history info
backend: couchdb
sessionid: 1486035364166-3bb78606-dd59-4679

$ ls
Applications   Desktop    Documents    Downloads

$ echo hi
hi
</pre></div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2番目のxonshセッションを開始する：</font></font></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ history info
backend: couchdb
sessionid: 1486035430658-6f81cd5d-b6d4-4f6a

$ echo new
new

$ history show all -nt
0:(2017-02-02 19:36) history info
1:(2017-02-02 19:36) ls
2:(2017-02-02 19:37) echo hi
3:(2017-02-02 19:37) history info
4:(2017-02-02 19:37) echo new

$ history -nt
0:(2017-02-02 19:37) history info
1:(2017-02-02 19:37) echo new
2:(2017-02-02 19:37) history show all -nt
</pre></div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは歴史を欠いているわけではないので、私たちは行くのがいいようです！</font></font></p>
</div>
<div class="section" id="history-garbage-collection">
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">履歴ガベージコレクション</font></font><a class="headerlink" href="#history-garbage-collection" title="この見出しにパーマリンク"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下のための歴史のバックエンドを内蔵</font></font><code class="docutils literal notranslate"><span class="pre">json</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、</font></font><code class="docutils literal notranslate"><span class="pre">sqlite</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xonshが開始されたとき、またはユーザーが実行したときに、ガベージコレクションがトリガされます</font><font style="vertical-align: inherit;">。</font><a class="reference external" href="envvars.html#xonsh-history-size"><font style="vertical-align: inherit;">$ XONSH_HISTORY_SIZEで</font></a><font style="vertical-align: inherit;">定義された範囲外の履歴項目
 </font><font style="vertical-align: inherit;">は削除されます。</font></font><code class="docutils literal notranslate"><span class="pre">history</span> <span class="pre">gc</span></code><font style="vertical-align: inherit;"></font><a class="reference external" href="envvars.html#xonsh-history-size"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">History</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">run_gc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">"""Run the garbage collector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        size: None or tuple of a int and a string</span>
<span class="sd">            Determines the size and units of what would be allowed to remain.</span>
<span class="sd">        blocking: bool</span>
<span class="sd">            If set blocking, then wait until gc action finished.</span>
<span class="sd">        """</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">履歴公開メソッド</font></font><code class="docutils literal notranslate"><span class="pre">run_gc()</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、この目的のためです。</font><font style="vertical-align: inherit;">私たち
 </font></font><code class="docutils literal notranslate"><span class="pre">CouchDBHistory</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はこのメソッドを定義していないので、親から継承します</font></font><code class="docutils literal notranslate"><span class="pre">History</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、何もしません。</font><font style="vertical-align: inherit;">私たちはGC実装を練習問題として残します。</font></font></p>
</div>
<div class="section" id="other-history-options">
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その他の履歴オプション</font></font><a class="headerlink" href="#other-history-options" title="この見出しにパーマリンク"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">履歴バックエンドの動作を変更する環境変数がいくつかあります。</font></font><a class="reference external" href="envvars.html#histcontrol"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ HISTCONTROL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、
 </font></font><a class="reference external" href="envvars.html#xonsh-history-size"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ XONSH_HISTORY_SIZE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、
 </font></font><a class="reference external" href="envvars.html#xonsh-store-stdout"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ XONSH_STORE_STDOUT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの</font><font style="vertical-align: inherit;">ようなものです</font><font style="vertical-align: inherit;">。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらのENVをCouchDBバックエンドに実装する必要があります。</font><font style="vertical-align: inherit;">幸いにも、それは難しいことではありません。</font><font style="vertical-align: inherit;">これらの機能の実装はあなたに任せておきますが</font></font><a class="reference external" href="_modules/xonsh/history/sqlite.html#SqliteHistory"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、sqliteバックエンド</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の処理方法を確認できます
 </font><font style="vertical-align: inherit;">。</font></font></p>
</div>
<div class="section" id="wrap-up">
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ラップアップ</font></font><a class="headerlink" href="#wrap-up" title="この見出しにパーマリンク"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これはベアボーンの実装ですが、あなたのニーズに合わせてxonshの履歴バックエンドをカスタマイズする方法を理解できますように！</font></font></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="sidebar.html" title="サイドバー">
          <img class="logo" src="_static/ascii_conch_part_transparent_tight.png" alt="ロゴ" />
        </a></p><div class="sphinx-toc sphinxlocaltoc">
    <h3><a href="sidebar.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページの内容</font></font></a></h3>
    <ul>
<li><a class="reference internal" href="#"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チュートリアル：独自のヒストリーバックエンドを書く</font></font></a><ul>
<li><a class="reference internal" href="#start-with-a-minimal-history-template"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最小履歴テンプレートから始める</font></font></a></li>
<li><a class="reference internal" href="#setup-couchdb"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CouchDBのセットアップ</font></font></a></li>
<li><a class="reference internal" href="#initialize-history-backend"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">履歴バックエンドの初期化</font></font></a></li>
<li><a class="reference internal" href="#save-history-to-couchdb"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">履歴をCouchDBに保存する</font></font></a></li>
<li><a class="reference internal" href="#retrieve-history-items"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">履歴項目を取得する</font></font></a></li>
<li><a class="reference internal" href="#try-out-our-new-history-backend"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちの新しいヒストリーバックエンドを試してみてください</font></font></a></li>
<li><a class="reference internal" href="#history-garbage-collection"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">歴史ガベージコレクション</font></font></a></li>
<li><a class="reference internal" href="#other-history-options"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その他の履歴オプション</font></font></a></li>
<li><a class="reference internal" href="#wrap-up"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要約</font></font></a></li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前のページ</font></font></h4>
    <p class="topless"><a href="tutorial_completers.html" title="前のページ"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">←チュートリアル：プログラマブルタブ完成</font></font></a></p>
  </div>
  <div class="sphinxnext">
    <h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のページ</font></font></h4>
    <p class="topless"><a href="tutorial_subproc_strings.html" title="次のページ"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">→チュートリアル：サブプロセス文字列</font></font></a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このページ</font></font></h3>
    <ul class="this-page-menu">
      <li><a href="_sources/tutorial_history_backend.rst.txt" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースを表示</font></font></a></li>
    </ul>
   </div>
<div id="searchbox" style="" role="search">
  <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クイック検索</font></font></h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><input type="submit" value="行こう" /></font></font>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="サイドバーメニューを非表示にする"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                 «
                </font></font><span class="show-for-small"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メニューを隠す</font></font></span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="サイドバーメニューを表示する" style="display: none;">
                
                <span class="show-for-small"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メニューの</font></font></span>
                <span class="hide-for-small"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サイドバー</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
                 »
            </font></font></button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ナビゲーション</font></font></h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="一般索引"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">索引</font></font></a></li>
        <li class="right">
          <a href="py-modindex.html" title="Pythonモジュールのインデックス"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュール</font></font></a>    </li>
        <li class="right">
          <a href="tutorial_subproc_strings.html" title="チュートリアル：サブプロセス文字列"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次</font></font></a>    </li>
        <li class="right">
          <a href="tutorial_completers.html" title="チュートリアル：プログラマブルタブ完成"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前</font></font></a>    </li>
    <li><a href="sidebar.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xonsh 0.8.5 documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »</font></font></li>

          <li class="nav-item nav-item-1"><a href="index.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xonshシェル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »</font></font></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        ©Copyright 2015、Anthony Scopatz。</font></font><a href="http://sphinx-doc.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sphinx</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1.8.2 </font><font style="vertical-align: inherit;">を使用して作成されました</font><font style="vertical-align: inherit;">。
    </font></font></div>
    <!-- cloud_sptheme 1.4 -->
  
<div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google 翻訳" /></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">原文</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">翻訳を改善する</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;" /><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><div class="hide-for-small"></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"/></svg></div></div></body></html>
